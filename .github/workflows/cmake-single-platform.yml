# NGINX Dynamic Module Build Workflow
name: Build nginx-s3-gateway_c Module

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true  # if nginx is a submodule

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev libcurl4-openssl-dev git

    - name: Checkout NGINX Source
      if: hashFiles('nginx') == ''
      run: |
        git clone --depth 1 -b stable-1.28 https://github.com/nginx/nginx.git
      # Note: Adjust NGINX version as needed

    - name: Fix Library Path in Config
      run: |
        # Update config if needed for Ubuntu paths
        ls -l .
        sed -i 's|-L/opt/local/lib|-L/usr/lib/x86_64-linux-gnu|g' config || true

    - name: Configure NGINX with Dynamic Module
      run: |
        ls "$GITHUB_WORKSPACE"
        echo "$PWD"
        cd nginx
        ./auto/configure \
          --with-compat \
          --add-dynamic-module="$GITHUB_WORKSPACE" \
          --with-http_ssl_module \
          --without-http_gzip_module
        make modules

    - name: Verify Build Output
      run: |
        ls -la nginx/objs/ngx_http_s3_gateway_c_module.so
        file nginx/objs/ngx_http_s3_gateway_c_module.so

    - name: Upload Module Artifact
      uses: actions/upload-artifact@v4
      with:
        name: nginx-s3-gateway-module
        path: nginx/objs/ngx_http_s3_gateway_c_module.so
        retention-days: 30

  test:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Module Artifact
      uses: actions/download-artifact@v4
      with:
        name: nginx-s3-gateway-module
        path: nginx/objs/
    
    - name: Install NGINX for Testing
      run: |
        sudo apt-get update
        sudo apt-get install -y nginx libnginx-mod-http-subs-filter
    
    - name: Install Module and Test Config
      run: |
        sudo cp nginx/objs/ngx_http_s3_gateway_c_module.so /usr/lib/nginx/modules/
        which nginx
        nginx -V
        sudo nginx -t -c examples/nginx-c-module-snippet.conf || echo "Config test skipped - requires env vars"
    
    - name: Run Perl Tests (if present)
      run: |
        echo "$PWD"
        ls -l .
        if [ -f "test/perl/run.sh" ]; then
          bash test/perl/run.sh || echo "Tests require S3 setup"
        fi
        echo "Test environment ready"
