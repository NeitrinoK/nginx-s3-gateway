# Fixed C module config - Complete working template
# Place in http/server context (not standalone locations)

# Required maps/variables (http context)
map $request_uri $uri_path {
    "~^(?P<path>.*?)(\\\\?.*)*$" $path;
}

set $forIndexPage true;
set $indexIsEmpty true;
set $cache_signing_key_enabled 0;
set $cache_instance_credentials_enabled 0;

map $request_uri $instance_credential_json { default ""; }
map $request_uri $signing_key_hash { default ""; }

# S3 host (adjust for your bucket/region)
set $s3_host "${S3_BUCKET_NAME}.${S3_SERVER}";  # virtual style
# set $s3_host "${S3_SERVER}";  # path style

# Upstream (http context) - dummy for testing, replace with real S3
upstream storage_urls {
    server ${S3_SERVER}:${S3_SERVER_PORT};
}

# Main locations (server context)
location / {
    auth_request /aws/credentials/retrieve;
    s3_gateway_content redirectToS3;
}

location /aws/credentials/retrieve {
    internal;
    s3_gateway_content fetchCredentials;
}

location @s3 {
    # Replace includes with direct C module variables
    proxy_set_header Authorization $s3auth;
    proxy_set_header X-Amz-Security-Token $awsSessionToken;
    proxy_set_header Host $s3_host;
    
    # SigV4 headers (adjust based on AWS_SIGS_VERSION env)
    proxy_set_header x-amz-date $awsDate;
    proxy_set_header x-amz-content-sha256 $awsPayloadHash;
    
    # SigV2 alternative (uncomment if AWS_SIGS_VERSION=2)
    # proxy_set_header Date $httpDate;
    
    proxy_http_version 1.1;
    proxy_set_header Connection '';
    
    proxy_pass https://storage_urls$s3uri;
}

location @s3_sliced {
    proxy_cache s3_cache_slices;
    proxy_cache_valid 200 302 206 1h;  # ${PROXY_CACHE_VALID_OK}
    proxy_cache_key "$request_method$host$uri$slice_range";

    slice 1m;  # ${PROXY_CACHE_SLICE_SIZE}
    proxy_set_header Range $slice_range;
    
    # Inline s3_location_common.conf equivalent
    proxy_set_header Authorization $s3auth;
    proxy_set_header X-Amz-Security-Token $awsSessionToken;
    proxy_set_header Host $s3_host;
    proxy_set_header x-amz-date $awsDate;
    proxy_set_header x-amz-content-sha256 $awsPayloadHash;
    
    proxy_pass https://storage_urls$s3uri;
}

location @s3PreListing {
    # Inline v${AWS_SIGS_VERSION}_headers.conf + cors.conf
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'Range';

    proxy_pass_request_headers off;
    proxy_ssl_server_name on;
    proxy_ssl_name $s3_host;

    proxy_set_header Authorization $s3auth;
    proxy_set_header X-Amz-Security-Token $awsSessionToken;
    proxy_set_header Host $s3_host;

    proxy_http_version 1.1;
    proxy_set_header Connection '';

    s3_gateway_header_filter on;
    s3_gateway_body_filter on;

    # XSLT for listing (create /etc/nginx/include/listing.xsl separately)
    # xslt_stylesheet /etc/nginx/include/listing.xsl;
    # xslt_string_param rootPath '/';
    # xslt_types application/xml;

    proxy_intercept_errors on;
    error_page 400-599 =404 @error404;

    s3_gateway_content loadContent;
}

location @trailslashControl {
    s3_gateway_content trailslashControl;
}

# Error handler
location @error404 {
    return 404;
}
